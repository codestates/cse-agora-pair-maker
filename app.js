require("dotenv").config();
const { App } = require("@slack/bolt");
const { WebClient, ErrorCode } = require("@slack/web-api");
const schedule = require("node-schedule");
const token = process.env.SLACK_BOT_TOKEN;

const cseChannelId = "C026MQ2GV2T";
const agoraChannelId = "C01TALAJ7QU";
const web = new WebClient(token);

const app = new App({
  token: process.env.SLACK_BOT_TOKEN,
  signingSecret: process.env.SLACK_SIGNING_SECRET,
  scopes: [
    "channels:history",
    "chat:write",
    "commands",
    "channels:join",
    "channels:read",
    "users:read",
  ],
  socketMode: true,
  appToken: process.env.SLACK_APP_TOKEN,
  port: process.env.PORT || 3000,
});

let excluded = [];
let isShuffled = false;
let pairList = [];
let userList = [];

// prettier-ignore
const emojis = [
	'ğŸ˜„','ğŸ˜ƒ','ğŸ˜€','ğŸ˜Š','ğŸ™‚','ğŸ˜‰','ğŸ˜','ğŸ˜˜','ğŸ˜š','ğŸ˜—','ğŸ˜™','ğŸ˜œ','ğŸ˜','ğŸ˜›','ğŸ˜³','ğŸ˜','ğŸ˜”','ğŸ˜Œ','ğŸ˜’','ğŸ˜','ğŸ˜£','ğŸ˜¢','ğŸ˜‚','ğŸ˜­','ğŸ˜ª','ğŸ˜¥','ğŸ˜°','ğŸ˜…','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ˜¨','ğŸ˜±','ğŸ˜ ','ğŸ˜¡','ğŸ˜¤','ğŸ˜–','ğŸ˜†','ğŸ˜‹','ğŸ˜·','ğŸ˜','ğŸ˜´','ğŸ˜µ','ğŸ˜²','ğŸ˜Ÿ','ğŸ˜¦','ğŸ˜§','ğŸ˜ˆ','ğŸ‘¿','ğŸ˜®','ğŸ˜¬','ğŸ˜','ğŸ˜•','ğŸ˜¯','ğŸ˜¶','ğŸ˜‡','ğŸ˜','ğŸ˜‘','ğŸ‘²','ğŸ‘³','ğŸ‘®','ğŸ‘·','ğŸ’‚','ğŸ‘¶','ğŸ‘¦','ğŸ‘§','ğŸ‘¨','ğŸ‘©','ğŸ‘´','ğŸ‘µ','ğŸ‘±','ğŸ‘¼','ğŸ‘¸','ğŸ˜º','ğŸ˜¸','ğŸ˜»','ğŸ˜½','ğŸ˜¼','ğŸ™€','ğŸ˜¿','ğŸ˜¹','ğŸ˜¾','ğŸ‘¹','ğŸ‘º','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’€','ğŸ‘½','ğŸ’©','ğŸ”¥','âœ¨','ğŸŒŸ','ğŸ’«','ğŸ’¥','ğŸ’¢','ğŸ’¦','ğŸ’§','ğŸ’¤','ğŸ’¨','ğŸ‘‚','ğŸ‘€','ğŸ‘ƒ','ğŸ‘…','ğŸ‘„','ğŸ‘','ğŸ‘','ğŸ‘Œ','ğŸ‘Š','âœŠ','âœŒ','ğŸ‘‹','âœ‹','ğŸ‘','ğŸ‘†','ğŸ‘‡','ğŸ‘‰','ğŸ‘ˆ','ğŸ™Œ','ğŸ™','â˜','ğŸ‘','ğŸ’ª','ğŸš¶','ğŸƒ','ğŸ’ƒ','ğŸ‘«','ğŸ‘ª','ğŸ‘¬','ğŸ‘­','ğŸ’','ğŸ’‘','ğŸ‘¯','ğŸ™†','ğŸ™…','ğŸ’','ğŸ™‹','ğŸ’†','ğŸ’‡','ğŸ’…','ğŸ‘°','ğŸ™','ğŸ™','ğŸ™‡','ğŸ©','ğŸ‘‘','ğŸ‘’','ğŸ‘Ÿ','ğŸ‘','ğŸ‘¡','ğŸ‘ ','ğŸ‘¢','ğŸ‘•','ğŸ‘”','ğŸ‘š','ğŸ‘—','ğŸ½','ğŸ‘–','ğŸ‘˜','ğŸ‘™','ğŸ’¼','ğŸ‘œ','ğŸ‘','ğŸ‘›','ğŸ‘“','ğŸ€','ğŸŒ‚','ğŸ’„','ğŸ’›','ğŸ’™','ğŸ’œ','ğŸ’š','â¤','ğŸ’”','ğŸ’—','ğŸ’“','ğŸ’•','ğŸ’–','ğŸ’','ğŸ’˜','ğŸ’Œ','ğŸ’‹','ğŸ’','ğŸ’','ğŸ‘¤','ğŸ‘¥','ğŸ’¬','ğŸ‘£','ğŸ’­','ğŸ¶','ğŸº','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¸','ğŸ¯','ğŸ¨','ğŸ»','ğŸ·','ğŸ½','ğŸ®','ğŸ—','ğŸµ','ğŸ’','ğŸ´','ğŸ‘','ğŸ˜','ğŸ¼','ğŸ§','ğŸ¦','ğŸ¤','ğŸ¥','ğŸ£','ğŸ”','ğŸ','ğŸ¢','ğŸ›','ğŸ','ğŸœ','ğŸ','ğŸŒ','ğŸ™','ğŸš','ğŸ ','ğŸŸ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ„','ğŸ','ğŸ€','ğŸƒ','ğŸ…','ğŸ‡','ğŸ‰','ğŸ','ğŸ','ğŸ“','ğŸ•','ğŸ–','ğŸ','ğŸ‚','ğŸ²','ğŸ¡','ğŸŠ','ğŸ«','ğŸª','ğŸ†','ğŸˆ','ğŸ©','ğŸ¾','ğŸ’','ğŸŒ¸','ğŸŒ·','ğŸ€','ğŸŒ¹','ğŸŒ»','ğŸŒº','ğŸ','ğŸƒ','ğŸ‚','ğŸŒ¿','ğŸŒ¾','ğŸ„','ğŸŒµ','ğŸŒ´','ğŸŒ²','ğŸŒ³','ğŸŒ°','ğŸŒ±','ğŸŒ¼','ğŸŒ','ğŸŒ','ğŸŒ','ğŸŒš','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒœ','ğŸŒ›','ğŸŒ™','ğŸŒ','ğŸŒ','ğŸŒ','ğŸŒ‹','ğŸŒŒ','ğŸŒ ','â­','â˜€','â›…','â˜','âš¡','â˜”','â„','â›„','ğŸŒ€','ğŸŒ','ğŸŒˆ','ğŸŒŠ','ğŸ','ğŸ’','ğŸ','ğŸ’','ğŸ“','ğŸ','ğŸ†','ğŸ‡','ğŸ','ğŸ‘','ğŸƒ','ğŸ‘»','ğŸ…','ğŸ„','ğŸ','ğŸ‹','ğŸ‰','ğŸŠ','ğŸˆ','ğŸŒ','ğŸ”®','ğŸ¥','ğŸ“·','ğŸ“¹','ğŸ“¼','ğŸ’¿','ğŸ“€','ğŸ’½','ğŸ’¾','ğŸ’»','ğŸ“±','â˜','ğŸ“','ğŸ“Ÿ','ğŸ“ ','ğŸ“¡','ğŸ“º','ğŸ“»','ğŸ”Š','ğŸ”‰','ğŸ”ˆ','ğŸ”‡','ğŸ””','ğŸ”•','ğŸ“¢','ğŸ“£','â³','âŒ›','â°','âŒš','ğŸ”“','ğŸ”’','ğŸ”','ğŸ”','ğŸ”‘','ğŸ”','ğŸ’¡','ğŸ”¦','ğŸ”†','ğŸ”…','ğŸ”Œ','ğŸ”‹','ğŸ”','ğŸ›','ğŸ›€','ğŸš¿','ğŸš½','ğŸ”§','ğŸ”©','ğŸ”¨','ğŸšª','ğŸš¬','ğŸ’£','ğŸ”«','ğŸ”ª','ğŸ’Š','ğŸ’‰','ğŸ’°','ğŸ’´','ğŸ’µ','ğŸ’·','ğŸ’¶','ğŸ’³','ğŸ’¸','ğŸ“²','ğŸ“§','ğŸ“¥','ğŸ“¤','âœ‰','ğŸ“©','ğŸ“¨','ğŸ“¯','ğŸ“«','ğŸ“ª','ğŸ“¬','ğŸ“­','ğŸ“®','ğŸ“¦','ğŸ“','ğŸ“„','ğŸ“ƒ','ğŸ“‘','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ“œ','ğŸ“‹','ğŸ“…','ğŸ“†','ğŸ“‡','ğŸ“','ğŸ“‚','âœ‚','ğŸ“Œ','ğŸ“','âœ’','âœ','ğŸ“','ğŸ“','ğŸ“•','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ““','ğŸ“”','ğŸ“’','ğŸ“š','ğŸ“–','ğŸ”–','ğŸ“›','ğŸ”¬','ğŸ”­','ğŸ“°','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸµ','ğŸ¶','ğŸ¹','ğŸ»','ğŸº','ğŸ·','ğŸ¸','ğŸ‘¾','ğŸ®','ğŸƒ','ğŸ´','ğŸ€„','ğŸ²','ğŸ¯','ğŸˆ','ğŸ€','âš½','âš¾','ğŸ¾','ğŸ±','ğŸ‰','ğŸ³','â›³','ğŸšµ','ğŸš´','ğŸ','ğŸ‡','ğŸ†','ğŸ¿','ğŸ‚','ğŸŠ','ğŸ„','ğŸ£','â˜•','ğŸµ','ğŸ¶','ğŸ¼','ğŸº','ğŸ»','ğŸ¸','ğŸ¹','ğŸ·','ğŸ´','ğŸ•','ğŸ”','ğŸŸ','ğŸ—','ğŸ–','ğŸ','ğŸ›','ğŸ¤','ğŸ±','ğŸ£','ğŸ¥','ğŸ™','ğŸ˜','ğŸš','ğŸœ','ğŸ²','ğŸ¢','ğŸ¡','ğŸ³','ğŸ','ğŸ©','ğŸ®','ğŸ¦','ğŸ¨','ğŸ§','ğŸ‚','ğŸ°','ğŸª','ğŸ«','ğŸ¬','ğŸ­','ğŸ¯','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸ’','ğŸ‡','ğŸ‰','ğŸ“','ğŸ‘','ğŸˆ','ğŸŒ','ğŸ','ğŸ','ğŸ ','ğŸ†','ğŸ…','ğŸŒ½','ğŸ ','ğŸ¡','ğŸ«','ğŸ¢','ğŸ£','ğŸ¥','ğŸ¦','ğŸª','ğŸ©','ğŸ¨','ğŸ’’','â›ª','ğŸ¬','ğŸ¤','ğŸŒ‡','ğŸŒ†','ğŸ¯','ğŸ°','â›º','ğŸ­','ğŸ—¼','ğŸ—¾','ğŸ—»','ğŸŒ„','ğŸŒ…','ğŸŒƒ','ğŸ—½','ğŸŒ‰','ğŸ ','ğŸ¡','â›²','ğŸ¢','ğŸš¢','â›µ','ğŸš¤','ğŸš£','âš“','ğŸš€','âœˆ','ğŸ’º','ğŸš','ğŸš‚','ğŸšŠ','ğŸš‰','ğŸš','ğŸš†','ğŸš„','ğŸš…','ğŸšˆ','ğŸš‡','ğŸš','ğŸš‹','ğŸšƒ','ğŸš','ğŸšŒ','ğŸš','ğŸš™','ğŸš˜','ğŸš—','ğŸš•','ğŸš–','ğŸš›','ğŸšš','ğŸš¨','ğŸš“','ğŸš”','ğŸš’','ğŸš‘','ğŸš','ğŸš²','ğŸš¡','ğŸšŸ','ğŸš ','ğŸšœ','ğŸ’ˆ','ğŸš','ğŸ«','ğŸš¦','ğŸš¥','âš ','ğŸš§','ğŸ”°','â›½','ğŸ®','ğŸ°','â™¨','ğŸ—¿','ğŸª','ğŸ­','ğŸ“','ğŸš©','â¬†','â¬‡','â¬…','â¡','ğŸ” ','ğŸ”¡','ğŸ”¤','â†—','â†–','â†˜','â†™','â†”','â†•','ğŸ”„','â—€','â–¶','ğŸ”¼','ğŸ”½','â†©','â†ª','â„¹','âª','â©','â«','â¬','â¤µ','â¤´','ğŸ†—','ğŸ”€','ğŸ”','ğŸ”‚','ğŸ†•','ğŸ†™','ğŸ†’','ğŸ†“','ğŸ†–','ğŸ“¶','ğŸ¦','ğŸˆ','ğŸˆ¯','ğŸˆ³','ğŸˆµ','ğŸˆ´','ğŸˆ²','ğŸ‰','ğŸˆ¹','ğŸˆº','ğŸˆ¶','ğŸˆš','ğŸš»','ğŸš¹','ğŸšº','ğŸš¼','ğŸš¾','ğŸš°','ğŸš®','ğŸ…¿','â™¿','ğŸš­','ğŸˆ·','ğŸˆ¸','ğŸˆ‚','â“‚','ğŸ›‚','ğŸ›„','ğŸ›…','ğŸ›ƒ','ğŸ‰‘','ãŠ™','ãŠ—','ğŸ†‘','ğŸ†˜','ğŸ†”','ğŸš«','ğŸ”','ğŸ“µ','ğŸš¯','ğŸš±','ğŸš³','ğŸš·','ğŸš¸','â›”','âœ³','â‡','â','âœ…','âœ´','ğŸ’Ÿ','ğŸ†š','ğŸ“³','ğŸ“´','ğŸ…°','ğŸ…±','ğŸ†','ğŸ…¾','ğŸ’ ','â¿','â™»','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','â›','ğŸ”¯','ğŸ§','ğŸ’¹','ğŸ’²','ğŸ’±','Â©','Â®','â„¢','ã€½','ã€°','ğŸ”','ğŸ”š','ğŸ”™','ğŸ”›','ğŸ”œ','âŒ','â­•','â—','â“','â•','â”','ğŸ”ƒ','ğŸ•›','ğŸ•§','ğŸ•','ğŸ•œ','ğŸ•‘','ğŸ•','ğŸ•’','ğŸ•','ğŸ•“','ğŸ•Ÿ','ğŸ•”','ğŸ• ','ğŸ••','ğŸ•–','ğŸ•—','ğŸ•˜','ğŸ•™','ğŸ•š','ğŸ•¡','ğŸ•¢','ğŸ•£','ğŸ•¤','ğŸ•¥','ğŸ•¦','âœ–','â•','â–','â—','â™ ','â™¥','â™£','â™¦','ğŸ’®','ğŸ’¯','âœ”','â˜‘','ğŸ”˜','ğŸ”—','â°','ğŸ”±','ğŸ”²','ğŸ”³','â—¼','â—»','â—¾','â—½','â–ª','â–«','ğŸ”º','â¬œ','â¬›','âš«','âšª','ğŸ”´','ğŸ”µ','ğŸ”»','ğŸ”¶','ğŸ”·','ğŸ”¸','ğŸ”¹'
];

function randomEmojis() {
  return emojis[Math.floor(Math.random() * emojis.length)];
}

const makePair = async function () {
  console.log(isShuffled, "isShuffled");
  console.log(excluded, "excluded");
  if (!isShuffled) {
    userList = await getUserList();
    pairList = shuffleUsernames(userList);
    isShuffled = true;
    return pairList;
  } else {
    return pairList;
  }
};

makePair();

async function getUserList() {
  try {
    const users = await web.conversations.members({
      channel: cseChannelId,
      token: token,
    });
    const userIds = users.members;
    const usernames = [];

    for (let i = 0; i < userIds.length; i++) {
      const username = await web.users.info({
        token: token,
        user: userIds[i],
      });
      if (
        username.user.tz.includes("Asia") &&
        !excluded.includes(username.user.real_name)
      ) {
        usernames.push(username.user.real_name);
      }
    }
    return usernames;
  } catch (error) {
    console.log(error);
  }
}

function shuffleUsernames(usernames) {
  try {
    const shuffle = (usernames) => {
      const copyUsernames = usernames.slice();
      return copyUsernames.sort(() => Math.random() - 0.5);
    };
    const shuffledUsernames = shuffle(usernames);

    let pairs = "";
    for (let i = 0; i < shuffledUsernames.length; i += 2) {
      let pair = shuffledUsernames.slice(i, i + 2);

      if (i === shuffledUsernames.length - 3) {
        pair = shuffledUsernames.slice(-3);
        pairs += `${randomEmojis()} ${pair}\n`;
        break;
      }
      pairs += `${randomEmojis()} ${pair}\n`;
    }
    return pairs.slice(0, pairs.length - 1);
  } catch (error) {
    console.log(error);
  }
}

async function noticePair() {
  const pairList = await makePair();
  try {
    await web.chat.postMessage({
      channel: cseChannelId,
      text: `ì´ë²ˆ ì£¼ ì•„ê³ ë¼ í˜ì–´ ëª…ë‹¨ì…ë‹ˆë‹¤!\n${pairList}\nì„œë¡œ í˜ì„ ëª¨ì•„ ì¢‹ì€ ë‹µë³€ì„ í•´ì£¼ì„¸ìš”.`,
    });
    await web.chat.postMessage({
      channel: agoraChannelId,
      text: `ì´ë²ˆ ì£¼ ì•„ê³ ë¼ í˜ì–´ ëª…ë‹¨ì…ë‹ˆë‹¤!\n${pairList}\nì„œë¡œ í˜ì„ ëª¨ì•„ ì¢‹ì€ ë‹µë³€ì„ í•´ì£¼ì„¸ìš”.`,
    });
  } catch (err) {
    console.log(err);
  }
}

function excludeUser(user) {
  if (userList.includes(user)) {
    excluded.push(user);
    const rest = userList.filter((user) => !excluded.includes(user));
    return rest;
  } else {
    return null;
  }
}

app.command("/ì œì™¸", async ({ command, ack, respond }) => {
  await ack();

  const rest = excludeUser(command.text);
  //!TODO: ì—¬ëŸ¬ ëª… í•œ ë²ˆì— ì œì™¸ ê¸°ëŠ¥ ì¶”ê°€
  if (rest) {
    await respond(
      `${command.text}(ì€/ëŠ”) ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤. \nì „ì²´ ëª…ë‹¨ì€ [${rest}]ì…ë‹ˆë‹¤`
    );
  } else {
    await respond(`${command.text}(ì€/ëŠ”) ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤`);
  }
});

app.command("/í˜ì–´", async ({ command, ack, respond }) => {
  await ack();
  const pairList = await makePair();
  await respond(`ê¸ˆì£¼ì˜ ì•„ê³ ë¼ í˜ì–´ëŠ” \n${pairList}\nì…ë‹ˆë‹¤`);
});

app.command("/", async ({ command, ack, respond }) => {
  await ack();

  await respond(`ìœ íš¨í•˜ì§€ ì•Šì€ ëª…ë ¹ì–´ì…ë‹ˆë‹¤`);
});

app.error((error) => {
  console.error(error);
});

const resetExcluded = () => {
  excluded = [];
};

const resetIsShuffled = () => {
  isShuffled = false;
};

schedule.scheduleJob("49 01 * * mon", resetIsShuffled);
schedule.scheduleJob("50 01 * * mon", noticePair);
schedule.scheduleJob("51 01 * * mon", resetExcluded);

(async () => {
  await app.start();

  console.log("âš¡ï¸ Bolt app is running!");
})();

//  1. ì›”ìš”ì¼ ì•„ì¹¨ 10ì‹œ 50ë¶„ì— í˜ì–´ ë§¤ì¹­í•˜ê¸°
//  1-1. í˜„ì¬ ì±„ë„ì— ìˆëŠ” êµ¬ì„±ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
//  1-2. ê°€ì ¸ì˜¨ ì‚¬ëŒì´ í™€ìˆ˜ë©´ í•œ ì¡°ëŠ” 3ì¸ìœ¼ë¡œ ì§ì„ ì§“ê³ , ì§ìˆ˜ë©´ 2ì¸ì”© ì§ì§“ëŠ”ë‹¤.
//  1-3. ë§¤ì£¼ ì›”ìš”ì¼ ì•„ì¹¨ 10ì‹œ 50ë¶„ì— ê³µì§€í•œë‹¤
//  2. slashCommands
//  2-1.ëª…ë ¹ì–´ '/í˜ì–´' ì…ë ¥ ì‹œ ê¸ˆì£¼ í˜ì–´ ëª©ë¡ ì¶œë ¥í•˜ê¸°
//  2-2. ëª…ë ¹ì–´ '/ì œì™¸ ã…‡ã…‡ã…‡' ì…ë ¥ ì‹œ íŠ¹ì • ìœ ì € ì°¨ì£¼ í˜ì–´ ëª©ë¡ì—ì„œ ì œê±°í•˜ê¸°
//  2-3. ì œì™¸ ë°°ì—´ì„ ì¼ì£¼ì¼ê°„ in-memory cachingí•œë‹¤. í˜ì–´ ê³µì§€ í›„ ë¹ˆ ë°°ì—´ë¡œ ë¦¬ì…‹í•œë‹¤.
//  todo: /ì¶”ê°€ ì œì™¸ ëœ êµ¬ì„±ì›ì„ ë‹¤ì‹œ ì¶”ê°€
//  todo: dbì— ìºì‹±
//  4. ë°°í¬
