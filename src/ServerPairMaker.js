const express = require("express");
const app = express();
const port = process.env.PORT || 80;
require("dotenv").config();
const cors = require("cors");
const morgan = require("morgan");
const bodyParser = require("body-parser");

const { WebClient, ErrorCode } = require("@slack/web-api");
const schedule = require("node-schedule");

const cseChannelId = "C026MQ2GV2T";
const agoraChannelId = "C01TALAJ7QU";
const token = process.env.SLACK_BOT_TOKEN;
const web = new WebClient(token);

app.use(express.json());
app.use(bodyParser.json());
app.use(express.urlencoded({ extended: true }));
app.use(
  morgan(":method :url :status :res[content-length] - :response-time ms")
);
app.use(cors());

app.get("/", (req, res, next) => {
  res.send("server running ");
});

let excluded = [];

const getUserList = async () => {
  try {
    const users = await web.conversations.members({
      channel: cseChannelId,
      token: token,
    });
    const userIds = users.members;
    const usernames = [];

    for (let i = 0; i < userIds.length; i++) {
      const username = await web.users.info({ token: token, user: userIds[i] });
      if (
        username.user.tz.includes("Asia") &&
        !excluded.includes(username.user.real_name)
      ) {
        usernames.push(username.user.real_name);
      }
    }
    return usernames;
  } catch (error) {
    if (error.code === ErrorCode.PlatformError) {
      console.log(error.data, cseChannelId);
    } else {
      console.log(error);
    }
  }
};

// prettier-ignore
const emojis = [
	'ðŸ˜„','ðŸ˜ƒ','ðŸ˜€','ðŸ˜Š','ðŸ™‚','ðŸ˜‰','ðŸ˜','ðŸ˜˜','ðŸ˜š','ðŸ˜—','ðŸ˜™','ðŸ˜œ','ðŸ˜','ðŸ˜›','ðŸ˜³','ðŸ˜','ðŸ˜”','ðŸ˜Œ','ðŸ˜’','ðŸ˜ž','ðŸ˜£','ðŸ˜¢','ðŸ˜‚','ðŸ˜­','ðŸ˜ª','ðŸ˜¥','ðŸ˜°','ðŸ˜…','ðŸ˜“','ðŸ˜©','ðŸ˜«','ðŸ˜¨','ðŸ˜±','ðŸ˜ ','ðŸ˜¡','ðŸ˜¤','ðŸ˜–','ðŸ˜†','ðŸ˜‹','ðŸ˜·','ðŸ˜Ž','ðŸ˜´','ðŸ˜µ','ðŸ˜²','ðŸ˜Ÿ','ðŸ˜¦','ðŸ˜§','ðŸ˜ˆ','ðŸ‘¿','ðŸ˜®','ðŸ˜¬','ðŸ˜','ðŸ˜•','ðŸ˜¯','ðŸ˜¶','ðŸ˜‡','ðŸ˜','ðŸ˜‘','ðŸ‘²','ðŸ‘³','ðŸ‘®','ðŸ‘·','ðŸ’‚','ðŸ‘¶','ðŸ‘¦','ðŸ‘§','ðŸ‘¨','ðŸ‘©','ðŸ‘´','ðŸ‘µ','ðŸ‘±','ðŸ‘¼','ðŸ‘¸','ðŸ˜º','ðŸ˜¸','ðŸ˜»','ðŸ˜½','ðŸ˜¼','ðŸ™€','ðŸ˜¿','ðŸ˜¹','ðŸ˜¾','ðŸ‘¹','ðŸ‘º','ðŸ™ˆ','ðŸ™‰','ðŸ™Š','ðŸ’€','ðŸ‘½','ðŸ’©','ðŸ”¥','âœ¨','ðŸŒŸ','ðŸ’«','ðŸ’¥','ðŸ’¢','ðŸ’¦','ðŸ’§','ðŸ’¤','ðŸ’¨','ðŸ‘‚','ðŸ‘€','ðŸ‘ƒ','ðŸ‘…','ðŸ‘„','ðŸ‘','ðŸ‘Ž','ðŸ‘Œ','ðŸ‘Š','âœŠ','âœŒ','ðŸ‘‹','âœ‹','ðŸ‘','ðŸ‘†','ðŸ‘‡','ðŸ‘‰','ðŸ‘ˆ','ðŸ™Œ','ðŸ™','â˜','ðŸ‘','ðŸ’ª','ðŸš¶','ðŸƒ','ðŸ’ƒ','ðŸ‘«','ðŸ‘ª','ðŸ‘¬','ðŸ‘­','ðŸ’','ðŸ’‘','ðŸ‘¯','ðŸ™†','ðŸ™…','ðŸ’','ðŸ™‹','ðŸ’†','ðŸ’‡','ðŸ’…','ðŸ‘°','ðŸ™Ž','ðŸ™','ðŸ™‡','ðŸŽ©','ðŸ‘‘','ðŸ‘’','ðŸ‘Ÿ','ðŸ‘ž','ðŸ‘¡','ðŸ‘ ','ðŸ‘¢','ðŸ‘•','ðŸ‘”','ðŸ‘š','ðŸ‘—','ðŸŽ½','ðŸ‘–','ðŸ‘˜','ðŸ‘™','ðŸ’¼','ðŸ‘œ','ðŸ‘','ðŸ‘›','ðŸ‘“','ðŸŽ€','ðŸŒ‚','ðŸ’„','ðŸ’›','ðŸ’™','ðŸ’œ','ðŸ’š','â¤','ðŸ’”','ðŸ’—','ðŸ’“','ðŸ’•','ðŸ’–','ðŸ’ž','ðŸ’˜','ðŸ’Œ','ðŸ’‹','ðŸ’','ðŸ’Ž','ðŸ‘¤','ðŸ‘¥','ðŸ’¬','ðŸ‘£','ðŸ’­','ðŸ¶','ðŸº','ðŸ±','ðŸ­','ðŸ¹','ðŸ°','ðŸ¸','ðŸ¯','ðŸ¨','ðŸ»','ðŸ·','ðŸ½','ðŸ®','ðŸ—','ðŸµ','ðŸ’','ðŸ´','ðŸ‘','ðŸ˜','ðŸ¼','ðŸ§','ðŸ¦','ðŸ¤','ðŸ¥','ðŸ£','ðŸ”','ðŸ','ðŸ¢','ðŸ›','ðŸ','ðŸœ','ðŸž','ðŸŒ','ðŸ™','ðŸš','ðŸ ','ðŸŸ','ðŸ¬','ðŸ³','ðŸ‹','ðŸ„','ðŸ','ðŸ€','ðŸƒ','ðŸ…','ðŸ‡','ðŸ‰','ðŸŽ','ðŸ','ðŸ“','ðŸ•','ðŸ–','ðŸ','ðŸ‚','ðŸ²','ðŸ¡','ðŸŠ','ðŸ«','ðŸª','ðŸ†','ðŸˆ','ðŸ©','ðŸ¾','ðŸ’','ðŸŒ¸','ðŸŒ·','ðŸ€','ðŸŒ¹','ðŸŒ»','ðŸŒº','ðŸ','ðŸƒ','ðŸ‚','ðŸŒ¿','ðŸŒ¾','ðŸ„','ðŸŒµ','ðŸŒ´','ðŸŒ²','ðŸŒ³','ðŸŒ°','ðŸŒ±','ðŸŒ¼','ðŸŒ','ðŸŒž','ðŸŒ','ðŸŒš','ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜','ðŸŒœ','ðŸŒ›','ðŸŒ™','ðŸŒ','ðŸŒŽ','ðŸŒ','ðŸŒ‹','ðŸŒŒ','ðŸŒ ','â­','â˜€','â›…','â˜','âš¡','â˜”','â„','â›„','ðŸŒ€','ðŸŒ','ðŸŒˆ','ðŸŒŠ','ðŸŽ','ðŸ’','ðŸŽŽ','ðŸŽ’','ðŸŽ“','ðŸŽ','ðŸŽ†','ðŸŽ‡','ðŸŽ','ðŸŽ‘','ðŸŽƒ','ðŸ‘»','ðŸŽ…','ðŸŽ„','ðŸŽ','ðŸŽ‹','ðŸŽ‰','ðŸŽŠ','ðŸŽˆ','ðŸŽŒ','ðŸ”®','ðŸŽ¥','ðŸ“·','ðŸ“¹','ðŸ“¼','ðŸ’¿','ðŸ“€','ðŸ’½','ðŸ’¾','ðŸ’»','ðŸ“±','â˜Ž','ðŸ“ž','ðŸ“Ÿ','ðŸ“ ','ðŸ“¡','ðŸ“º','ðŸ“»','ðŸ”Š','ðŸ”‰','ðŸ”ˆ','ðŸ”‡','ðŸ””','ðŸ”•','ðŸ“¢','ðŸ“£','â³','âŒ›','â°','âŒš','ðŸ”“','ðŸ”’','ðŸ”','ðŸ”','ðŸ”‘','ðŸ”Ž','ðŸ’¡','ðŸ”¦','ðŸ”†','ðŸ”…','ðŸ”Œ','ðŸ”‹','ðŸ”','ðŸ›','ðŸ›€','ðŸš¿','ðŸš½','ðŸ”§','ðŸ”©','ðŸ”¨','ðŸšª','ðŸš¬','ðŸ’£','ðŸ”«','ðŸ”ª','ðŸ’Š','ðŸ’‰','ðŸ’°','ðŸ’´','ðŸ’µ','ðŸ’·','ðŸ’¶','ðŸ’³','ðŸ’¸','ðŸ“²','ðŸ“§','ðŸ“¥','ðŸ“¤','âœ‰','ðŸ“©','ðŸ“¨','ðŸ“¯','ðŸ“«','ðŸ“ª','ðŸ“¬','ðŸ“­','ðŸ“®','ðŸ“¦','ðŸ“','ðŸ“„','ðŸ“ƒ','ðŸ“‘','ðŸ“Š','ðŸ“ˆ','ðŸ“‰','ðŸ“œ','ðŸ“‹','ðŸ“…','ðŸ“†','ðŸ“‡','ðŸ“','ðŸ“‚','âœ‚','ðŸ“Œ','ðŸ“Ž','âœ’','âœ','ðŸ“','ðŸ“','ðŸ“•','ðŸ“—','ðŸ“˜','ðŸ“™','ðŸ““','ðŸ“”','ðŸ“’','ðŸ“š','ðŸ“–','ðŸ”–','ðŸ“›','ðŸ”¬','ðŸ”­','ðŸ“°','ðŸŽ¨','ðŸŽ¬','ðŸŽ¤','ðŸŽ§','ðŸŽ¼','ðŸŽµ','ðŸŽ¶','ðŸŽ¹','ðŸŽ»','ðŸŽº','ðŸŽ·','ðŸŽ¸','ðŸ‘¾','ðŸŽ®','ðŸƒ','ðŸŽ´','ðŸ€„','ðŸŽ²','ðŸŽ¯','ðŸˆ','ðŸ€','âš½','âš¾','ðŸŽ¾','ðŸŽ±','ðŸ‰','ðŸŽ³','â›³','ðŸšµ','ðŸš´','ðŸ','ðŸ‡','ðŸ†','ðŸŽ¿','ðŸ‚','ðŸŠ','ðŸ„','ðŸŽ£','â˜•','ðŸµ','ðŸ¶','ðŸ¼','ðŸº','ðŸ»','ðŸ¸','ðŸ¹','ðŸ·','ðŸ´','ðŸ•','ðŸ”','ðŸŸ','ðŸ—','ðŸ–','ðŸ','ðŸ›','ðŸ¤','ðŸ±','ðŸ£','ðŸ¥','ðŸ™','ðŸ˜','ðŸš','ðŸœ','ðŸ²','ðŸ¢','ðŸ¡','ðŸ³','ðŸž','ðŸ©','ðŸ®','ðŸ¦','ðŸ¨','ðŸ§','ðŸŽ‚','ðŸ°','ðŸª','ðŸ«','ðŸ¬','ðŸ­','ðŸ¯','ðŸŽ','ðŸ','ðŸŠ','ðŸ‹','ðŸ’','ðŸ‡','ðŸ‰','ðŸ“','ðŸ‘','ðŸˆ','ðŸŒ','ðŸ','ðŸ','ðŸ ','ðŸ†','ðŸ…','ðŸŒ½','ðŸ ','ðŸ¡','ðŸ«','ðŸ¢','ðŸ£','ðŸ¥','ðŸ¦','ðŸª','ðŸ©','ðŸ¨','ðŸ’’','â›ª','ðŸ¬','ðŸ¤','ðŸŒ‡','ðŸŒ†','ðŸ¯','ðŸ°','â›º','ðŸ­','ðŸ—¼','ðŸ—¾','ðŸ—»','ðŸŒ„','ðŸŒ…','ðŸŒƒ','ðŸ—½','ðŸŒ‰','ðŸŽ ','ðŸŽ¡','â›²','ðŸŽ¢','ðŸš¢','â›µ','ðŸš¤','ðŸš£','âš“','ðŸš€','âœˆ','ðŸ’º','ðŸš','ðŸš‚','ðŸšŠ','ðŸš‰','ðŸšž','ðŸš†','ðŸš„','ðŸš…','ðŸšˆ','ðŸš‡','ðŸš','ðŸš‹','ðŸšƒ','ðŸšŽ','ðŸšŒ','ðŸš','ðŸš™','ðŸš˜','ðŸš—','ðŸš•','ðŸš–','ðŸš›','ðŸšš','ðŸš¨','ðŸš“','ðŸš”','ðŸš’','ðŸš‘','ðŸš','ðŸš²','ðŸš¡','ðŸšŸ','ðŸš ','ðŸšœ','ðŸ’ˆ','ðŸš','ðŸŽ«','ðŸš¦','ðŸš¥','âš ','ðŸš§','ðŸ”°','â›½','ðŸ®','ðŸŽ°','â™¨','ðŸ—¿','ðŸŽª','ðŸŽ­','ðŸ“','ðŸš©','â¬†','â¬‡','â¬…','âž¡','ðŸ” ','ðŸ”¡','ðŸ”¤','â†—','â†–','â†˜','â†™','â†”','â†•','ðŸ”„','â—€','â–¶','ðŸ”¼','ðŸ”½','â†©','â†ª','â„¹','âª','â©','â«','â¬','â¤µ','â¤´','ðŸ†—','ðŸ”€','ðŸ”','ðŸ”‚','ðŸ†•','ðŸ†™','ðŸ†’','ðŸ†“','ðŸ†–','ðŸ“¶','ðŸŽ¦','ðŸˆ','ðŸˆ¯','ðŸˆ³','ðŸˆµ','ðŸˆ´','ðŸˆ²','ðŸ‰','ðŸˆ¹','ðŸˆº','ðŸˆ¶','ðŸˆš','ðŸš»','ðŸš¹','ðŸšº','ðŸš¼','ðŸš¾','ðŸš°','ðŸš®','ðŸ…¿','â™¿','ðŸš­','ðŸˆ·','ðŸˆ¸','ðŸˆ‚','â“‚','ðŸ›‚','ðŸ›„','ðŸ›…','ðŸ›ƒ','ðŸ‰‘','ãŠ™','ãŠ—','ðŸ†‘','ðŸ†˜','ðŸ†”','ðŸš«','ðŸ”ž','ðŸ“µ','ðŸš¯','ðŸš±','ðŸš³','ðŸš·','ðŸš¸','â›”','âœ³','â‡','âŽ','âœ…','âœ´','ðŸ’Ÿ','ðŸ†š','ðŸ“³','ðŸ“´','ðŸ…°','ðŸ…±','ðŸ†Ž','ðŸ…¾','ðŸ’ ','âž¿','â™»','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™Ž','â™','â™','â™‘','â™’','â™“','â›Ž','ðŸ”¯','ðŸ§','ðŸ’¹','ðŸ’²','ðŸ’±','Â©','Â®','â„¢','ã€½','ã€°','ðŸ”','ðŸ”š','ðŸ”™','ðŸ”›','ðŸ”œ','âŒ','â­•','â—','â“','â•','â”','ðŸ”ƒ','ðŸ•›','ðŸ•§','ðŸ•','ðŸ•œ','ðŸ•‘','ðŸ•','ðŸ•’','ðŸ•ž','ðŸ•“','ðŸ•Ÿ','ðŸ•”','ðŸ• ','ðŸ••','ðŸ•–','ðŸ•—','ðŸ•˜','ðŸ•™','ðŸ•š','ðŸ•¡','ðŸ•¢','ðŸ•£','ðŸ•¤','ðŸ•¥','ðŸ•¦','âœ–','âž•','âž–','âž—','â™ ','â™¥','â™£','â™¦','ðŸ’®','ðŸ’¯','âœ”','â˜‘','ðŸ”˜','ðŸ”—','âž°','ðŸ”±','ðŸ”²','ðŸ”³','â—¼','â—»','â—¾','â—½','â–ª','â–«','ðŸ”º','â¬œ','â¬›','âš«','âšª','ðŸ”´','ðŸ”µ','ðŸ”»','ðŸ”¶','ðŸ”·','ðŸ”¸','ðŸ”¹'
];

function randomEmojis() {
  return emojis[Math.floor(Math.random() * emojis.length)];
}

const makePair = (usernames) => {
  try {
    const shuffle = (usernames) => {
      const copyUsernames = usernames.slice();
      return copyUsernames.sort(() => Math.random() - 0.5);
    };
    const shuffledUsernames = shuffle(usernames);

    let pairs = "";
    for (let i = 0; i < shuffledUsernames.length; i += 2) {
      let pair = shuffledUsernames.slice(i, i + 2);

      if (i === shuffledUsernames.length - 3) {
        pair = shuffledUsernames.slice(-3);
        pairs += `${randomEmojis()} ${pair}\n`;
        break;
      }
      pairs += `${randomEmojis()} ${pair}\n`;
    }
    return pairs.slice(0, pairs.length - 1);
  } catch (error) {
    console.log(error);
  }
};

getUserList()
  .then((userList) => {
    const pairList = makePair(userList);

    app.post("/", (req, res) => {
      if (req.body.command.split("/")[1] === "íŽ˜ì–´") {
        res.send(`ê¸ˆì£¼ì˜ ì•„ê³ ë¼ íŽ˜ì–´ëŠ” \n${pairList}\nìž…ë‹ˆë‹¤`);
      } else if (req.body.command.split("/")[1] === "ì œì™¸") {
        excluded.push(req.body.text);
        const rest = userList.filter((user) => !excluded.includes(user));
        res.send(
          `${req.body.text}(ì€/ëŠ”) ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤. \nì „ì²´ ëª…ë‹¨ì€ [${rest}]ìž…ë‹ˆë‹¤`
        );
      } else {
        res.end("í•´ë‹¹í•˜ëŠ” ëª…ë ¹ì–´ê°€ ì—†ìŠµë‹ˆë‹¤");
      }
    });

    const noticePair = async () => {
      try {
        await web.chat.postMessage({
          channel: cseChannelId,
          text: `ì´ë²ˆ ì£¼ ì•„ê³ ë¼ íŽ˜ì–´ ëª…ë‹¨ìž…ë‹ˆë‹¤!\n${pairList}\nì„œë¡œ íž˜ì„ ëª¨ì•„ ì¢‹ì€ ë‹µë³€ì„ í•´ì£¼ì„¸ìš”.`,
        });
        await web.chat.postMessage({
          channel: agoraChannelId,
          text: `ì´ë²ˆ ì£¼ ì•„ê³ ë¼ íŽ˜ì–´ ëª…ë‹¨ìž…ë‹ˆë‹¤!\n${pairList}\nì„œë¡œ íž˜ì„ ëª¨ì•„ ì¢‹ì€ ë‹µë³€ì„ í•´ì£¼ì„¸ìš”.`,
        });
      } catch (err) {
        console.log(err);
      }
    };
    schedule.scheduleJob("50 01 * * mon", noticePair);
  })
  .catch((err) => {
    console.log(err);
  });

const resetExcluded = () => {
  excluded = [];
};

//  1. ì›”ìš”ì¼ ì•„ì¹¨ 9ì‹œì— íŽ˜ì–´ ë§¤ì¹­í•˜ê¸°  => done
// * 1-1. ì¼ë‹¨ í˜„ìž¬ ì±„ë„ì— ìžˆëŠ” êµ¬ì„±ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
// * 1-2. ê°€ì ¸ì˜¨ ì‚¬ëžŒì´ í™€ìˆ˜ë©´ í•œ ì¡°ëŠ” 3ì¸ìœ¼ë¡œ ì§ì„ ì§“ê³ , ì§ìˆ˜ë©´ 2ì¸ì”© ì§ì§“ëŠ”ë‹¤.
// * 1-3. ë§¤ì£¼ ì›”ìš”ì¼ ì•„ì¹¨ 9ì‹œì— ê³µì§€í•œë‹¤
// todo: 2. ëª…ë ¹ì–´ '/íŽ˜ì–´' ìž…ë ¥ ì‹œ íŽ˜ì–´ ëª©ë¡ ì¶œë ¥í•˜ê¸°
// 2-1. ëª…ë ¹ì–´ '/íŽ˜ì–´ã…‡ã…‡ã…‡ì œì™¸' ìž…ë ¥ ì‹œ íŠ¹ì • ìœ ì € íŽ˜ì–´ ëª©ë¡ì—ì„œ ì œê±°í•˜ê¸°
// 2-2. ì œê±°í•œ ìƒíƒœì—ì„œ íŽ˜ì–´ ìž¬ë§¤ì¹­í•´ì„œ ê³µì§€
// todo: 3 ë°°í¬

// ! refactor
// ! íŽ˜ì–´ ëª…ë‹¨ ë°›ì•„ì˜¤ëŠ” ê±´ 1ì£¼ì¼ ì£¼ê¸°, ë©”ì‹œì§€ ë³´ë‚´ëŠ” ì£¼ê¸°ë„ ë§ˆì°¬ê°€ì§€
// ! ì´ ë°°ì—´ì„ ì¼ì£¼ì¼ê°„ in-memory cachingí•œë‹¤.
// ! ê·¸ ì‚¬ì´ì— ë³€í™”ëŠ” /ì œê±° ëª…ë ¹ì–´ í†µí•´ íŠ¸ëž˜í‚¹í•œë‹¤.

// 1. /íŽ˜ì–´ ì¹˜ë©´ ì§ì „ì— ë³´ë‚´ì¤€ê±° ê·¸ëŒ€ë¡œ ë³´ë‚´ì¤˜ì•¼ í•¨
// 2. /ì œì™¸ ëŠ” 1ì£¼ì¼ë§Œ ì œì™¸ ì‹œí‚´
// 3. optional /ì¶”ê°€ ì œì™¸ ëœ êµ¬ì„±ì›ì„ ë‹¤ì‹œ ì¶”ê°€

schedule.scheduleJob("10 02 * * mon", resetExcluded);

app.listen(port, () => console.log(`server is running at ${port}`));
